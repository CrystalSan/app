{include file="inc/header.html"}
<style>
    .pay_bind_bottom{position: relative}
    #registerInput{
        display: none;
    }
    .bind{width: 35%;padding: 5%;text-align: center;position: absolute;top: 15%;left: 0;}
    .bind_tips{
        position: absolute;
        top: -40px;
        line-height: 20px;
        text-align: center;
        width: 100%;
        overflow: hidden;
        height: 40px;
        font-size: 12px;
    }
    .avatar{display: block;width: 30%;margin: 5% auto;}
    .font_aa{
        /*color: #c0c0c0;*/
        font-size: 14px;
    }
    .font_b{color: #ff7800;}
    .tip_box{
        position: absolute;
        top: 140px;
        left: 0;
        right: 0;}
    .button_login.disabled{
        background:#dddddd;
        color:#999999;
    }
</style>
<script>
    /*user.js中所用的url*/
    var urls = {}
    urls.submitUrl = '{url r="user#do_register"}';
    urls.sendSMSUrl = APP_ROOT+"/index.php?ctl=ajax&act=send_mobile_verify_code&is_only=1";
    urls.checkVerifyCodeUrl = '{url r="user#check_field"}';
</script>
<!--选择登录方式-->
<!--<div class="bind">
    <div class="bind_top">
        <div class="bind_top_left">
            <img src="{if $wx_info.headimgurl}{$wx_info.headimgurl}{else}{$TMPL}/images/u36.png{/if}" class="img-circle avatar">
        </div>
        <div class="bind_top_right">
            <p class="font_aa">欢迎您！</p>
            <p><strong class="font_age">{$wx_info.nickname}</strong></p>
            <p class="font_aa">正在使用微信账号登录新乐筹</p>
        </div>
    </div>
</div>-->
<div class="blank"></div>
<div class="login">
    <div class="tip_box font_b">{if $error}{$error}{else}恭喜您成功用微信号注册新乐筹用户，请进行手机号绑定，享受更好的服务{/if}</div>

    <!--div class="form-group logo_table logo_table1">
        <label for="name" class="logo_tex"><span><img src="{$TMPL}/images/biao.png" border="0"></span>会员名称:</label>
        <input type="text" id="user_name" name="user_name" class="form-control input_width" placeholder="请输入会员名称">
        <div class="tip_box"><div class="form_tip">请输入会员帐号</div></div>
    </div>-->
    <input type="text" id="user_name" name="user_name" hidden="hidden" value="{$wx_info.nickname}">
    <div class="form-group logo_table logo_table1">
        <label for="name" class="logo_tex"><span><img src="{$TMPL}/images/biao.png" border="0"></span>手机号码:</label>
        <input type="text" class="form-control input_width" id="settings_mobile" name="mobile" placeholder="请输入手机号码11位">
    </div>
    <div class="form-group logo_table logo_table1">
        <label for="name" class="logo_tex"><span><img src="{$TMPL}/images/biao.png" border="0"></span>输入密码:</label>
        <input type="password" id="user_pwd" name="user_pwd" class="form-control input_width" placeholder="请输入至少8位数字加英文密码">
    </div>

    <div id="registerInput" style="display: none;">
        <div class="form-group logo_table logo_table1">
            <label for="name" class="logo_tex"><span><img src="{$TMPL}/images/biao.png" border="0"></span>确认密码:</label>
            <input type="password" id="confirm_user_pwd" name="confirm_user_pwd" class="form-control input_width" placeholder="请输入至少8位数字加英文密码">
        </div>

        <div class="form-group logo_table logo_table1">
            <label for="name" class="logo_tex"><span><img src="{$TMPL}/images/biao.png" border="0"></span>手机验证:</label>
            <input type="text" class="form-control input_test" id="verify_coder" name="verify_coder" placeholder="请输入验证码">
            <a href="javascript:void(0);" id="J_send_sms_verify" class="test_code">获取验证码</a>
        </div>

    </div>
    <div class="form-group logo_table " style="margin:0 auto;text-align:center;">
        <button id="submitBindBtn" class="button_login {if $error}disabled{/if}" style="margin-left:37%;" {if $error}disabled="disabled"{/if}>绑定并登录</button>
    </div>
</div>

</div>
<script type="text/javascript" src="{$TMPL}/js/user.js"></script>
<!--bind-->
<script>
    $(function(){
        $("#settings_mobile").live('blur',bind.next);// check mobile status
        $("#submitBindBtn").bind('click',bind.submit);
    })
    var bind = {
        type:'reg',//默认注册
        next:function(){
            if(user.checkPhone()){
                bind.checkMobileStatus();
            };
        },
        checkMobileStatus:function(){
            var url = APP_ROOT+"/appdata.php?act=app_check_mobile";
            var p = {'mobile':$("#settings_mobile").val()};
            user.sendAjax(url,p,function(json){
                var oBtn = $('#submitBindBtn');
                switch (json.error){
                    case '0':
                        //新用户
                        showBindtips('新用户，请输入密码&验证码完成绑定');
                        bind.type = 'reg';
                        $('#registerInput').slideDown();
                        if(oBtn.hasClass('disabled')){oBtn.attr('disabled',false).removeClass('disabled')}
//                            $('#registerInput').addClass('show');
                        break;
                    case '-1':
                        //老用户，可输入密码绑定
                        showBindtips('老用户，输入密码完成绑定');
                        bind.type = 'login';
                        $('#registerInput').slideUp();
                        if(oBtn.hasClass('disabled')){oBtn.attr('disabled',false).removeClass('disabled')}
                        break;
                    case '-2':
                        showBindtips('此账号已绑定微信，请去个人中心解绑');
                        oBtn.attr('disabled',true).addClass('disabled');
                        break;

                }
            });
        },
        submit:function(){
            var u_info = user.formData,username = "{$wx_info.nickname}",
                    param = {user_name:username,mobile:u_info.phone.val(),user_pwd:u_info.password.val(),type:bind.type},
                    url = APP_ROOT+'/?ctl=user&act=do_bind_mobile';

            if(bind.type=="reg"){
                param.confirm_user_pwd = u_info.rePassword.val();
                param.verify_coder = u_info.verifyCode.val();
                if(!(user.checkPhone()&&user.checkPassword())) return false;
            }else{
                if(!user.checkPhone()) return false;
                if(param.user_pwd==""||param.user_pwd.length<4){
                    $.showErr('密码格式不正确');return false;
                }
            }
            user.sendAjax(url,param,function(json){
//                        alert(e.status)
                if (json.status == 1) {
                    location.href = json.jump;
                } else {
                    $.showErr(json.info);
                }
            });
        }
    }
    function showBindtips(msg){
        var $div = $('.tip_box');
        $div.html(msg).fadeIn();
    }
</script>
{include file="inc/footer.html"} 


